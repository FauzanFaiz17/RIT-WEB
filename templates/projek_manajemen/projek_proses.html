{% extends "layouts/base-fullscreen.html" %}
{% block title %} Proses Projek {% endblock title %}

<style>
  .today-marker {
    background-color: rgba(255, 0, 0, 0.5);
  }
</style>
{% block content %}
<div class="container-fluid card">
    <div class="row">
        <div class="col-md-6" style="overflow-x: auto;">
            <h1 class="mt-3">Proses Projek: {{ projek.nama }}</h1>
            <p>Divisi : {{ projek.divisi.nama }}</p>
            <div>
                <a class="btn btn-primary mt-4" href="{% url "buat_task" projek.id %}">Buat Task</a>
                <a href="{% url "export_pdf_projek" projek.id %}" class="btn btn-secondary mt-4">Export pdf</a>
                <div class="progress-wrapper mt-4">
                    <div class="progress-info d-flex justify-content-between align-items-center">
                        <div class="small fw-bold text-gray-500">Progres Keseluruhan</div>
                        <div class="small fw-bold text-gray-700">{{ projek_progress }}%</div>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar {% if projek_progress < 30 %}bg-danger{% elif projek_progress < 70 %}bg-warning{% else %}bg-success{% endif %}" 
                            role="progressbar" 
                            style="width: {{ projek_progress }}%;" 
                            aria-valuenow="{{ projek_progress }}" 
                            aria-valuemin="0" 
                            aria-valuemax="100">
                        </div>
                    </div>
                </div>

            </div>
            {% for task in projek.tasks.all %}
            <div style="min-width: 600px;">
            <table class="table table-flush table-bordered mt-4 mb-4">
                <thead>
                    <tr>
                        <th>{{ task.nama }}</th>
                        <th>Tanggal Mulai</th>
                        <th>Tanggal Selesai</th>
                        <th>Aksi</th>
                        <th style="width: -1%;">
                            <div class="dropdown">
                                <button class="btn dropdown-toggle" type="button" id="dropdownMenu{{ task.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                    â‹®
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenu{{ task.id }}">
                                    <li><a class="dropdown-item lowercase" href="{% url "buat_subtask" projek.id task.id %}">Tambah Subtask</a></li>
                                    <li><a class="dropdown-item" href="{% url "edit_task" projek.id task.id %}">Edit Task</a></li>
                                    <li>
                                        <form action="{% url "hapus_task" projek.id task.id %}" method="POST" onsubmit="return confirm('Yakin ingin menghapus task ini?')">
                                            {% csrf_token %}
                                            <button type="submit" class="dropdown-item text-danger">Hapus Task</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for subtask in task.subtasks.all %}
                    <tr>
                        <td>{{ subtask.nama }}</td>
                        <td>{{ subtask.tanggal_mulai }}</td>
                        <td>{{ subtask.tanggal_selesai }}</td>
                        <td>
                            <a class="btn btn-sm btn-warning mb-1" href="{% url "edit_subtask" projek.id task.id subtask.id %}">Edit</a>
                            <form action="{% url 'hapus_subtask' projek.id task.id subtask.id %}" method="POST" style="display:inline;" onsubmit="return confirm('Yakin ingin menghapus subtask ini?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-danger">Hapus</button>
                            </form>
                        </td>
                        <td>{{ subtask.status }}</td>
                    </tr>
                    {% endfor %}
                    {% empty %}
                    <tr>
                        <td colspan="4">Tidak ada subtask untuk task ini.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
        <div class="col-md-6">
            <div id="chartDiv" style="width: 100%; height: 500px; margin-top: 220px;" class="mx-auto"></div>
        </div>
    </div>
</div>
<!-- CDN dari JSCharting Trial -->
<script src="https://code.jscharting.com/latest/jscharting.js"></script>

<script>
  var currentDate = '{{ timezone.now|date:"n/j/Y" }}';  // Misal: 6/20/2025
  var thresholdDate = norm(currentDate);

  var chart = JSC.chart('chartDiv', {
    title_label_text: 'Gantt Chart Proyek: {{ projek.nama }}',
    type: 'horizontal column solid',
    zAxis_scale_type: 'stacked',
    palette: ['#9adcfa', '#99e4ed', '#d0b6fa'],
    legend: {
      position: 'inside right top',
      template: '%icon %name'
    },
    toolbar_items_export_position: 'inside bottom left',
    yAxis: {
      scale_type: 'time',
      scale_range_padding: 0.15,
      markers: [
        {
          value: currentDate,
          color: 'red',
          label_text: 'Sekarang'
        }
      ]
    },
    defaultPoint: {
      outline_width: 0,
      radius: 0,
      label: {
        text: pointLabelText,
        placement: 'outside'
      },
      tooltip:
        '<b>%name</b><br/>%low - %high<br/>{days(%high-%low)} hari'
    },
    defaultSeries: {
      firstPoint: {
        outline: { color: 'darkenMore', width: 2 },
        xAxisTick_label_text: '<b>%value</b>'
      }
    },
    series: [
  {% for task in tasks %}
  {
    name: '{{ task.nama|escapejs }}',
    points: [
      {% for subtask in task.subtasks.all %}
      {
        name: '{{ subtask.nama|escapejs }}',
        y: ['{{ subtask.tanggal_mulai|date:"n/j/Y" }}', '{{ subtask.tanggal_selesai|date:"n/j/Y" }}'],
        status: '{{ subtask.status }}'  // <-- tambahkan field status
      },
      {% endfor %}
    ]
  },
  {% endfor %}
]
  });

  // === FUNGSI ===
  function pointLabelText(point) {
    var status = point.options('status'); // Ambil status dari poin

    if (status === 'selesai') {
        return getIconText('material/navigation/check', '#66BB6A', 16); // Ceklis Hijau
    } else {
        return getIconText('material/notification/close', '#FDD835', 20); // Cakra Kuning
    }
}

  function norm(d) {
    return new Date(d).getTime();
  }

  function getIconText(name, color, size) {
    return (
      '<icon name=' + name + ' size=' + size + ' fill=' + color + '>'
    );
  }
</script>

{% endblock content %}